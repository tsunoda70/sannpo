<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>今日の散歩コース</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    body { margin: 0; }
    #map { width: 100vw; height: 100vh; }
    .btn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: #2ecc71;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="btn" onclick="generateRoute()">今日の散歩コース</div>

  <script src="script.js"></script>
</body>
</html>

mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN";

let map;

navigator.geolocation.getCurrentPosition((pos) => {
  const start = [pos.coords.longitude, pos.coords.latitude];

  map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v12",
    center: start,
    zoom: 15
  });

  new mapboxgl.Marker().setLngLat(start).addTo(map);
  window.startPoint = start;
});

function generateRoute() {
  const radius = 0.005; // 約500m
  const today = new Date().toISOString().slice(0, 10);

  // 日付を使った疑似乱数
  const seed = today.split("-").join("");
  const rand = Math.sin(seed) * 10000;
  const angle = rand % (Math.PI * 2);

  const dx = Math.cos(angle) * radius;
  const dy = Math.sin(angle) * radius;

  const midPoint = [
    startPoint[0] + dx,
    startPoint[1] + dy
  ];

  const url = `https://api.mapbox.com/directions/v5/mapbox/walking/` +
    `${startPoint.join(",")};${midPoint.join(",")};${startPoint.join(",")}` +
    `?geometries=geojson&access_token=${mapboxgl.accessToken}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const route = data.routes[0].geometry;

      if (map.getSource("route")) {
        map.getSource("route").setData(route);
      } else {
        map.addSource("route", {
          type: "geojson",
          data: route
        });

        map.addLayer({
          id: "route",
          type: "line",
          source: "route",
          paint: {
            "line-color": "#e74c3c",
            "line-width": 5
          }
        });
      }
    });
}
