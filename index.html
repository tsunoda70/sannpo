<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ä»Šæ—¥ã®æ•£æ­©ã‚³ãƒ¼ã‚¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { width: 100vw; height: 100vh; }
    .btn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: #2ecc71;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="btn" onclick="tryGenerateRoute()">ä»Šæ—¥ã®æ•£æ­©ã‚³ãƒ¼ã‚¹</div>

<script>
mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN";

let map;
let startPoint;

// ---------- ç¾åœ¨åœ°å–å¾— ----------
navigator.geolocation.getCurrentPosition(pos => {
  startPoint = [pos.coords.longitude, pos.coords.latitude];

  map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v12",
    center: startPoint,
    zoom: 15
  });

  new mapboxgl.Marker().setLngLat(startPoint).addTo(map);
});

// ---------- localStorage ----------
function saveRoute(coords) {
  localStorage.setItem("lastRoute", JSON.stringify(coords));
}

function loadLastRoute() {
  const data = localStorage.getItem("lastRoute");
  return data ? JSON.parse(data) : null;
}

// ---------- è¢«ã‚Šç‡è¨ˆç®— ----------
function overlapRate(routeA, routeB) {
  const round = n => n.toFixed(4); // ç´„10mç²¾åº¦

  const setA = new Set(
    routeA.map(p => `${round(p[0])},${round(p[1])}`)
  );

  let overlap = 0;
  routeB.forEach(p => {
    const key = `${round(p[0])},${round(p[1])}`;
    if (setA.has(key)) overlap++;
  });

  return overlap / routeB.length;
}

// ---------- ãƒ«ãƒ¼ãƒˆç”Ÿæˆ ----------
function generateRandomRoute() {
  const radius = 0.005; // ç´„500m
  const today = new Date().toISOString().slice(0, 10);
  const seed = Number(today.replace(/-/g, ""));
  const angle = Math.sin(seed) * Math.PI * 2;

  const dx = Math.cos(angle) * radius;
  const dy = Math.sin(angle) * radius;

  const midPoint = [
    startPoint[0] + dx,
    startPoint[1] + dy
  ];

  const url =
    `https://api.mapbox.com/directions/v5/mapbox/walking/` +
    `${startPoint.join(",")};${midPoint.join(",")};${startPoint.join(",")}` +
    `?geometries=geojson&access_token=${mapboxgl.accessToken}`;

  return fetch(url)
    .then(res => res.json())
    .then(data => data.routes[0].geometry.coordinates);
}

// ---------- æç”» ----------
function drawRoute(coords) {
  const geojson = {
    type: "Feature",
    geometry: {
      type: "LineString",
      coordinates: coords
    }
  };

  if (map.getSource("route")) {
    map.getSource("route").setData(geojson);
  } else {
    map.addSource("route", { type: "geojson", data: geojson });
    map.addLayer({
      id: "route",
      type: "line",
      source: "route",
      paint: {
        "line-color": "#e74c3c",
        "line-width": 5
      }
    });
  }
}

// ---------- è¢«ã‚Šå›é¿ä»˜ãç”Ÿæˆ ----------
function tryGenerateRoute(attempt = 0) {
  if (attempt > 5) {
    alert("ä»Šæ—¥ã¯ã“ã‚Œä»¥ä¸Šæ–°ã—ã„é“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ ğŸ™");
    return;
  }

  generateRandomRoute().then(newRoute => {
    const lastRoute = loadLastRoute();

    if (lastRoute) {
      const rate = overlapRate(lastRoute, newRoute);
      if (rate > 0.4) {
        console.log("è¢«ã‚Šã™ã â†’ å†ç”Ÿæˆ", rate);
        tryGenerateRoute(attempt + 1);
        return;
      }
    }

    drawRoute(newRoute);
    saveRoute(newRoute);
  });
}
</script>

</body>
</html>
